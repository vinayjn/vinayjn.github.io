<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Univeral Pasteboard iOS, macOS, Android | Vinay Jain</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Univeral Pasteboard iOS, macOS, Android" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Why being in two different mobile ecosystems is so painful? Can a little bit of coding bridge the gap in between?" />
<meta property="og:description" content="Why being in two different mobile ecosystems is so painful? Can a little bit of coding bridge the gap in between?" />
<link rel="canonical" href="https://vinayjain.me/posts/shared-pasteboard" />
<meta property="og:url" content="https://vinayjain.me/posts/shared-pasteboard" />
<meta property="og:site_name" content="Vinay Jain" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-10-03T06:39:25+05:30" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Univeral Pasteboard iOS, macOS, Android" />
<script type="application/ld+json">
{"url":"https://vinayjain.me/posts/shared-pasteboard","headline":"Univeral Pasteboard iOS, macOS, Android","dateModified":"2020-10-03T06:39:25+05:30","datePublished":"2020-10-03T06:39:25+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://vinayjain.me/posts/shared-pasteboard"},"description":"Why being in two different mobile ecosystems is so painful? Can a little bit of coding bridge the gap in between?","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/css/light.css" id="theme-link">
  <script src="/assets/js/main.js"></script><link type="application/atom+xml" rel="alternate" href="https://vinayjain.me/feed.xml" title="Vinay Jain" /><script async src="https://www.googletagmanager.com/gtag/js?id=UA-128287990-1"></script>
<script>
  window['ga-disable-UA-128287990-1'] = window.doNotTrack === "1" || navigator.doNotTrack === "1" || navigator.doNotTrack === "yes" || navigator.msDoNotTrack === "1";
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-128287990-1');
</script>

</head>
<body><header class="site-header">

  <div class="wrapper"><div class="meta-header">
      <div class="site-info">
        <div class="site-title">
          <a rel="author" href="/">Vinay Jain</a>
        </div>
        <div class="site-description">
          <span>Developer • Tinkerer</span>
        </div>
      </div>
      <div>
        <img class="pp" src="/images/vinayjain.jpeg" />
      </div>
    </div><nav class="site-nav">
      
      <a class="page-link" href="/"> Home</a>
      
      <a class="page-link" href="/bookshelf/">Bookshelf</a>
      <a class="page-link" target="_blank" href="https://travel.vinayjain.me">Travel log</a>
    </nav></div>
</header><main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  
  <h1 class="post-title p-name" itemprop="name headline">Univeral Pasteboard iOS, macOS, Android</h1>    
  
  <div class="post-content e-content" itemprop="articleBody">
    <p>Do you recall the times when you had to touch-type a long website address on your phone’s baby keyboard and wished to copy it from your computer and continue browsing just by pasting the URL in the address bar? Such a painful and frustrating user-experience. I’ve been doing this for a long time, some people might still be doing this but things have changed on the iOS/macOS side and partially on the Android side and the number of WTFs/day have drastically reduced. With some coding, I can further reduce them down, let’s see.</p>

<p>Apple knew this was a problem so they fixed it with Handoff &amp; Continuity. The iPhone and the Mac are my primary devices but I also like using my Android phone, it has a long list of benefits. I am frequently switching devices for their specific features and use-cases, for all the software tinkering I pick my Android device, for example, I am running a <a href="https://vinayjain.me/posts/linux-on-android">Linux image on my Android</a> phone and on top of it I have setup pi-hole and this pi-hole server is set up as a proxy on my router to block ads and social media trackers on all devices in my home network. This hacking can’t be done on iOS because of the securely closed system. I miss some features of the Apple ecosystem when I am on Android, one such feature is Handoff and Continuity. More specifically, the universal pasteboard, the functionality of copying something on one device and pasting on another, really cool! This seems like a very small feature and indeed it is, but its impact on the user experience is huge. My life will be simpler if I can share pasteboard across all my devices including Android.</p>

<div class="align-center">
<blockquote class="twitter-tweet"><p lang="en" dir="ltr"><a href="https://twitter.com/hashtag/WeekendProject?src=hash&amp;ref_src=twsrc%5Etfw">#WeekendProject</a> One of the many advantages of being in the Apple ecosystem is Handoff between apps specifically the shared pasteboard. It&#39;ll be great if it can be shared with Android as well.</p>&mdash; Vinay Jain (@vinayjn7) <a href="https://twitter.com/vinayjn7/status/1271058739131330561?ref_src=twsrc%5Etfw">June 11, 2020</a></blockquote> 
</div>
<script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<h2 id="lets-build-this">Lets build this</h2>

<p>This implementation triggered as an idea in the evening and I rushed to Twitter to post it for validation. From the top it looks like a really complex system to build, and if I go on to implement the full functionality of Handoff and Continuity, it is indeed a difficult software to build. But when given a thought, what I need is a small subset of Apple’s implementation, the universal pasteboard. To build it, I need to know how Apple did it and what is the tech behind. With some little research, I got to know about BluetoothLE.</p>

<h2 id="bluetoothle">BluetoothLE</h2>

<p>Handoff &amp; Continuity uses <a href="https://www.bluetooth.com">BluetoothLE</a> (bluetooth low energy), a technology that helps nearby devices to communicate using significantly small data packets and low energy. The Bluetooth specification prefers to call the communicating devices as the Central and the Peripheral but in general terms its a client-server communication. The peripheral advertises one or more services &amp; characteristics, which can be found by the centrals with a Bluetooth scan. A central connects to a peripheral with a pairing process which may or may not require authentication.</p>

<p>The serivces and characteristics are important to understand because that is the only way the central can find a peripheral and send data to it. The central will write data on the characteristics which were advertised by the peripherals.</p>

<h3 id="the-gatt-server">The GATT server</h3>

<p>Advertisement of a service is totally different from data transfer. After pairing, the central is authorised to send data to the peripheral without permission. As the central is writing data to a characteristic, the peripheral needs to know how to handle this data. This can be done by setting up a GATT server on the peripheral. The server knows who is writing data on a particular characteristic and exposes certain methods to handle this data transfer. Our shared pasteboard implementaton relies on the GATT server.</p>

<h2 id="practicality">Practicality</h2>

<p>For this case, I am interested in getting pasteboard data from Mac to Android. I want my Android device to be discovered by a nearby Mac, you might think that turning on Bluetooth and pairing Android &amp; Mac would do that. Not completely, because Android is advertising the services it supports like file sharing, Bluetooth tethering etc. Luckily, I can use the standard Bluetooth pairing process of Android and don’t have to write any code for the authentication flow. By the time of writing this post, I couldn’t find any advertised services/characteristics that could potentially link to the Android pasteboard. Unfortunately/fortunately, I had to write all the code for advertisement, services and characteristics, GATT server and for the system pasteboard manipulation. This was just the part on Android side, I still need to write code that will send data to Android. Right! the central code on Mac.</p>

<h3 id="pasteboard-events">Pasteboard Events</h3>

<p>Anytime I hit Cmd+C on the Mac I need to send the selected data to Android. I initially thought that there must be an event(NSNotification) fired as soon as the pasteboard contents are updated, unfortunately this isn’t the case.</p>

<p>In computer science there are two ways to get updates from a system:</p>

<ul>
  <li>You(subscriber) subscribe to the updates on a system(publisher), and get notified for each change.</li>
  <li>You keep polling a system on regular time intervals and compare its latest value with the value you currently have. If it doesn’t match that means the system has a new value.</li>
</ul>

<p>As I mentioned, I won’t be able to use the publisher-subscriber model(the optimal approach) here, I had to turn my head towards polling. And like most of times I was able to find a solution with a little help from GitHub, thanks to <a href="https://gist.github.com/Daemon-Devarshi/13efd24f027a775ee862">Daemon-Devarshi</a> for their clean Swift implementation. Polling the pasteboard works because the amount of data transferred in polling isn’t that much and I can just ignore the battery related issues for now.</p>

<h3 id="the-central">The Central</h3>

<p>Since I already have the pasteboard updates, writing rest of the central code is relatively easy. Apart from the pasteboard code, the central has the following responsibilities:</p>

<ul>
  <li>Keep running in background</li>
  <li>Connect to the Android phone when pasteboard changes</li>
  <li>Send data to the connected Android phone</li>
</ul>

<p>With some help from <a href="https://developer.apple.com/documentation/corebluetooth">Core Bluetooth</a>, it took me a little time to write a macOS script that does all that. Just because I did the custom implementation of services and characteristics the central’s code can further be optimised to scan only for the specific services and characteristics I need. And with this it’s done, I have a working solution for a shared pasteboard between all my devices.</p>

<p>I’ll probably be pushing all this code on <a href="https://www.github.com/vinayjn">GitHub</a> after I refactor and clean it but I am not sure when. If you are still interested in looking into it let me know and I’ll speed up the process or may be send it to you directly over email.</p>

  </div><div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://vinayjain.me/posts/shared-pasteboard';
      this.page.identifier = 'https://vinayjain.me/posts/shared-pasteboard';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://koderme.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript><a class="u-url" href="/posts/shared-pasteboard" hidden></a>
</article>

      </div>
    </main>    
  </body>

</html>
